# Railway Deployment Guide

This project is configured for production deployment on Railway with WebSocket support via Redis.

## Prerequisites

- Railway account (https://railway.app)
- GitHub repository with code pushed
- MySQL and Redis services on Railway

## Quick Deployment Steps

### 1. Connect Your Repository to Railway
1. Log in to [Railway](https://railway.app)
2. Create a new project
3. Click "Deploy from GitHub repo"
4. Select `jaysonpardilla/3kub0` repository
5. Railway will automatically detect the Dockerfile and deploy

### 2. Add Services to Your Railway Project

#### Option A: Add MySQL Database
1. In Railway dashboard, click "+ Create" → "Database" → "MySQL"
2. Railway will automatically set environment variables:
   - `MYSQL_HOST=mysql.railway.internal`
   - `MYSQL_PASSWORD=<auto-generated>`
   - `MYSQL_USER=root`
   - `MYSQL_DATABASE=railway`

#### Option B: Add Redis Service
1. Click "+ Create" → "Database" → "Redis"
2. Railway will set `REDIS_URL` automatically

### 3. Configure Required Environment Variables

In your Railway project settings, add these variables:

```env
# Django Settings
DEBUG=False
SECRET_KEY=<generate-new-secure-key>
ALLOWED_HOSTS=your-app-name.railway.app

# MySQL Configuration (auto-set by Railway MySQL service)
MYSQL_DATABASE=railway
MYSQL_HOST=mysql.railway.internal
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=<from-mysql-service>

# Redis (auto-set by Railway Redis service)
REDIS_URL=<from-redis-service>

# Cloudinary
CLOUDINARY_URL=cloudinary://786333672776349:KyDW-AJ0wTkcVkcWPrqd_LLRlPg@deyrmzn1x

# Email
EMAIL_HOST_USER=jaysonpardilla278@gmail.com
EMAIL_HOST_PASSWORD=aagx obby uzrp tuhs
DEFAULT_FROM_EMAIL=pardillajayson004@gmail.com

# CORS
CORS_ALLOWED_ORIGINS=https://your-app-name.railway.app
```

### 4. Generate Secure SECRET_KEY

```bash
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
```

Copy the generated key and add it to Railway environment variables.

### 5. Trigger Deployment

After all environment variables are set in Railway, click "Redeploy" or push a new commit to GitHub to trigger deployment:

```bash
git push origin main
```

Railway will:
1. Build the Docker image
2. Run migrations automatically
3. Start the Daphne server
4. Connect to MySQL and Redis services

### 6. Verify Deployment

Check the deployment logs in Railway dashboard:
- Build logs should show successful Docker build
- Deploy logs should show migrations running
- App should be accessible at `https://your-app-name.railway.app`

### 7. Create Superuser (Optional)

```bash
railway run python manage.py createsuperuser
```

## Architecture

- **Web Server**: Daphne (ASGI) - Handles HTTP and WebSocket connections
- **Database**: MySQL - User and product data
- **Cache/Message Broker**: Redis - WebSocket message delivery across instances
- **Storage**: Cloudinary - All images (user profiles, products, business images)
- **Static Files**: WhiteNoise - Serves CSS, JS from CDN

## WebSocket Connection Flow

1. Client connects to WebSocket endpoint
2. Connection routed through Daphne ASGI server
3. Messages broadcast via Redis Channel Layer
4. Multiple instances can share messages through Redis

## Troubleshooting

### Build Errors
- Check Railway build logs for specific errors
- Ensure `requirements.txt` has all dependencies
- Verify Python version in `runtime.txt`

### Database Connection Errors
- Ensure MySQL service is running and connected
- Check environment variables match service credentials
- Run `railway connect mysql` to test database connection

### WebSocket Not Working
- Verify Redis service is deployed and running
- Check `CHANNEL_LAYERS` configuration uses Redis URL
- Monitor Railway logs for WebSocket errors

### View Deployment Logs
```bash
railway logs --service <service-name>
```

### Connect to Database
```bash
railway connect mysql
```

### Run Django Commands
```bash
railway run python manage.py <command>
```

## WebSocket Configuration

The project uses:
- **channels**: WebSocket framework
- **channels_redis**: Redis backend for multi-instance WebSocket support
- **daphne**: ASGI server

All WebSocket connections automatically use Redis for message passing, allowing horizontal scaling.

## Important Notes

1. **Redis is Required**: The WebSocket feature requires Redis. Without it, real-time chat won't work.
2. **Migrations**: Ensure migrations run before the app starts
3. **Static Files**: Handled by WhiteNoise middleware
4. **Media Files**: Stored on Cloudinary (not locally)
5. **HTTPS**: Enforced in production (DEBUG=False)

## Troubleshooting

### Check Logs
```bash
railway logs
```

### Connect to Database
```bash
railway connect mysql
```

### Check Redis Connection
```bash
railway run python -c "import redis; r = redis.from_url(os.getenv('REDIS_URL')); print(r.ping())"
```

### Run Django Management Commands
```bash
railway run python manage.py <command>
```

## Local Development

To test locally with production settings:

```bash
DEBUG=False python manage.py runserver
```

Make sure you have Redis running locally:
```bash
redis-cli
```
