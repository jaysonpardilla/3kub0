{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% block title %}
        <title>E-Kubo: chats</title>
    {% endblock title %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/chat1.css' %}">
    <link rel="stylesheet" href="{% static 'css/conversation1.css' %}">
    <link rel="stylesheet" href="{% static 'css/conversation2.css' %}">
    <link rel="icon" type="image/png" href="{% static 'icons/ekubo_icon.png' %}">
    <link rel="stylesheet" href="{% static 'css/slideup.css' %}">
</head>
<body style="background-color: #F5F5F5">
    {% include 'chat/navbar.html' %}
    <div class="container mt-2">
    <div class="row mt-1" style="background-color:#F5F5F5">
        <div class="col-md-3 sidebar" style="padding: 10px; border-radius: 5px; background-color:#EFEFEA">
            <!-- Sidebar for Users -->
            <h4 class="chat chat-label" style="font-family: 'Arial', sans-serif; margin-top: 2px;"><b>Chats</b></h4>
            <form method="GET" class="mb-3" onsubmit="return false;">
                {% csrf_token %}
                <input name="search_user" type="search" placeholder="Search here" class="form-control pl-3" style="width: 100%;">
            </form>
            <ul class="mt-2 align-items-left" style="padding: 0;">
                {% for user in users %}
                    <li>
                        <a href="{% url 'chat:chat_with' user.id %}">
                            <img width="50px" height="50px" 
                                src="{{ user.profile|profile_image_url }}" alt="Profile Picture"
                                data-user-name="{{ user.first_name }} {{ user.last_name }}"
                                style="border-radius: 50%; object-fit: cover;"
                                class="sidebar-profile-img">
                            <div style="flex: 1;">
                                <h5><b>{{ user.first_name }} {{ user.last_name }}</b></h5>
                                {% if user.business %}
                                <h6>shop: {{user.business.business_name}}</h6>
                                {% endif %}
                                {% with last_message|get_item:user.id as message %}
                                    <div class="last-message">
                                        {% if message %}
                                            {% if message.sender.username != request.user.username %}
                                                <span style="color: rgb(50, 100, 146);"><b>{{ message.content|slice:":15" }}{% if message.content|length > 15 %}...{% endif %}</b></span>
                                            {% else %}
                                                <span class="text-secondary">{{ message.content|slice:":15" }}{% if message.content|length > 15 %}...{% endif %}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">No messages yet.</span>
                                        {% endif %}
                                    </div>
                                {% endwith %}
                            </div>
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <div class="slide-up col-md-9 main-content" style="background-color: #F5F5F5;">
            <!-- Main Content for Chat -->  
            <div class="username" style="font-family: 'Arial', sans-serif; padding-top: 5px; padding-left: 5px ; background-color: #EFEFEA;">
                {% if current_user %}
                    <h5 style="margin-top:0%"><b>{{ current_user.first_name }} {{ current_user.last_name }}</b></h5>
                {% endif %} 
            </div>
            <div class="chat-container" id="chat-container" data-current-user-id="{{ current_user.id }}" style="padding: 10px; border-radius: 5px; font-family: Arial, sans-serif;">
    
                {% if messages %}
                    {% for message in messages %}
                        <div class="one-message">
                            {% if message.sender == request.user %}
                                <p class="text-center date">{{ message.timestamp|date:"M d Y D - H:i" }}</p>
                                <div class="chat-message-sender mb-3" style="margin-bottom: 5px;">
                                    <span class="chat-sender"  style="background-color: #a0a0a0; padding-top: 2px; padding-bottom: 3px; padding-left: 10px; padding-right: 10px; border-radius: 20px;">{{ message.content }}</span>
                                    <img src="{{ request.user.profile|profile_image_url }}" alt="" 
                                        data-user-name="{{ request.user.first_name }} {{ request.user.last_name }}"
                                        style="border-radius: 50%; object-fit: cover; width: 40px; height: 40px;"
                                        class="chat-profile-img">
                                </div>
                            {% else %}
                                <p class="text-center date">{{ message.timestamp|date:"M d Y D - H:i" }}</p>
                                <div class="chat-message-receiver mb-3">
                                    <img src="{{ message.sender.profile|profile_image_url }}" alt=""
                                        data-user-name="{{ message.sender.first_name }} {{ message.sender.last_name }}"
                                        style="border-radius: 50%; object-fit: cover; width: 40px; height: 40px;"
                                        class="chat-profile-img">
                                    <span class="chat-receiver" style="background-color: #a0a0a0; padding-top: 2px; padding-bottom: 3px; padding-left: 10px; padding-right: 10px; border-radius: 20px;">{{ message.content }}</span>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No messages yet. Start the conversation!</p>
                {% endif %}
            </div>
            <div class="message-form-wrapper">
                <form method="post" class="message-form" style="justify-content: end;" onsubmit="return false;">
                    {% csrf_token %}
                    <div class="span">
                        <textarea class="text" name="content" rows="1" placeholder="Type your message..." style="width: 600px;"></textarea>
                        <button class="btn btn-outline-dark send-button" type="button">Send</button>
                    </div>
                </form>
            </div>
            
            <!-- <input type="hidden" id="user-id-input" value="{{ request.user.id }}"> -->
            <input type="hidden" id="current-user-uuid" value="{{ request.user.id }}">
            <input type="hidden" id="sender-profile-image" value="{{ request.user.profile|profile_image_url }}">
            <input type="hidden" id="receiver-profile-image" value="{{ current_user.profile|profile_image_url }}">
        </div>
    </div>
    </div>

{% include 'chat/footer.html' %}
<script>
    const currentUserId = "{{ request.user.id }}";
    
    // Handle image errors for existing images (template-loaded)
    document.addEventListener('DOMContentLoaded', function() {
        function handleImageError(img) {
            const userName = img.getAttribute('data-user-name') || 'User';
            let initials = 'U';
            
            // Extract initials from user name
            const parts = userName.trim().split(' ').filter(part => part.length > 0);
            if (parts.length > 0) {
                initials = parts.map(part => part[0].toUpperCase()).join('').slice(0, 2);
            }
            
            // Create a styled div to replace the image
            const initialDiv = document.createElement('div');
            initialDiv.className = 'profile-initial';
            initialDiv.textContent = initials;
            initialDiv.style.width = '40px';
            initialDiv.style.height = '40px';
            initialDiv.style.borderRadius = '50%';
            initialDiv.style.display = 'flex';
            initialDiv.style.alignItems = 'center';
            initialDiv.style.justifyContent = 'center';
            initialDiv.style.backgroundColor = '#d0d0d0';
            initialDiv.style.color = '#333';
            initialDiv.style.fontWeight = 'bold';
            initialDiv.style.fontSize = '14px';
            initialDiv.style.minWidth = '40px';
            initialDiv.style.minHeight = '40px';
            initialDiv.style.flexShrink = '0';
            initialDiv.style.padding = '4px';
            
            img.replaceWith(initialDiv);
        }
        
        // Set error handlers for all profile images
        const profileImages = document.querySelectorAll('.sidebar-profile-img, .chat-profile-img');
        profileImages.forEach(img => {
            img.addEventListener('error', function() {
                handleImageError(this);
            });
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/conversation.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/slideup.js' %}"></script>
</body>
</html>